#!/bin/bash
#SBATCH -N 1                     
#SBATCH -n 1                    
#SBATCH --mail-type=END          
#SBATCH --mail-user=ddang@mit.edu       
#############################################

# ===== Required files and resources =====
# 1. Reference genome index (MMI file)
#    - Variable: $REFERENCE
#    - Format: .mmi (minimap2 prebuilt index)
#    - Generated from a FASTA file using:
#        minimap2 -d GRCh38.mmi GRCh38.fa
#    - Example: GRCh38.mmi
#
# 2. Reads file
#    - Variable: $READS
#    - Format: FASTQ or FASTQ.gz containing sequencing reads (paired or single-end)
#
# 3. Output files (generated by script)
#    - $OUTPUT (.sam) → SAM alignment file from minimap2
#    - aligned_minimap.bam → BAM version of the SAM file
#    - aligned_minimap_sorted.bam → Coordinate-sorted BAM
#    - aligned_minimap_sorted.bam.bai → BAM index for rapid access


source ~/miniconda3/etc/profile.d/conda.sh
conda activate minimap 

# ===== Define input/output paths =====
REFERENCE="GRCh38.mmi"         
READS="merged_reads.fastq.gz"   
OUTPUT="aligned_minimap.sam"    

# ===== Alignment with minimap2 =====
minimap2 -ax sr $REFERENCE $READS > $OUTPUT
# -a : output in SAM format
# -x sr : preset for short reads (Illumina-like)


# ===== Convert SAM to BAM =====
samtools view -Sb $OUTPUT > aligned_minimap.bam

# ===== Sort BAM by coordinate =====
samtools sort aligned_minimap.bam -o aligned_minimap_sorted.bam

# ===== Index BAM for rapid access =====
samtools index aligned_minimap_sorted.bam

echo "Alignment completed! Output: aligned_minimap_sorted.bam and aligned_minimap_sorted.bam.bai"
